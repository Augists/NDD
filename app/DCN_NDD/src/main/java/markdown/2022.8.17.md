# 原子数量变化情况

数据集：APKeep 6那个小数据集

- 更新完IP转发规则：71个
- 更新完Vxlan封装，76个
- 更新完VNI，*7
- 更新完epg，*11
- 更新完pbr，*13

理论全部更新完：76,076

# 有关原子merge的校准

我重新检查了代码，然后通过检查原子端口行为来保证任何两个原子肯定行为并不完全相同。

比如更新完vxlan后多出来的5个是合理的（验证方法：检查任意两个原子的所在端口是否一致，也就是检查``ap_ports``变量）原因分析如下。

# 等价类为什么会在更新vxlan后数量增加了

增加的5个原子分别是由原本的5个分裂出来的，也就是5个原子分裂为了10个，下面以410原子为例分析原因。

比如更新完fw后的原子410在更新完vxlan后变为了7642原子和7684原子。7642原子和7684原子的差别如下。

```java
7684：leaf-0-1_encapip=[838860802, 855638017]

7642：leaf-0-1_encapip=[838860802]
```

含义是，7684在leaf-0-1_encapip设备的838860802端口和855638017端口，而7642原子只存在于838860802端口。这俩原子的区别不止在leaf-0-1_encapip这一个设备上，但是和其他设备上的区别和这个设备一致，就只用这个为例子。

- 两个原子封装后的行为不同的原因

产生这种区别的原因是以下规则（该三条规则都在vxlan文件中）

```java
+ vxlan leaf-0-1_vpn3 167774209 32 838860802 32 32
+ vxlan leaf-0-1_vpn4 167774209 24 855638017 32 24
//以上两条说明了7684和7642都拥有838860802的原因，以下一条是7642没有855638017的原因
+ vxlan leaf-0-1_vpn3 167774208 24 838860802 32 24
```

- 两个原子没有封装规则前行为相同的原因

下图的规则都在fibs文件中

![image-20220817192210880](C:\Users\wbSun\AppData\Roaming\Typora\typora-user-images\image-20220817192210880.png)

可以看出，任何一个``167774209 32``的转发规则所在的设备，肯定有一个``167774208 24``的规则覆盖它，所以这两个ip在转发规则的时候被划分到一个原子。



# 等价类的数量知否支持做验证

目前看下来，从添加完vxlan规则后，后面乘法增长的内容目前没办法减少。分别添加了vni域，srcip域，epg域，都是正交的。而且这还是最小的数据集。