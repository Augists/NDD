# 拆封装的问题还是push的问题
封装是否有问题：封装的原则是，default端口直接过，不是default就继续，所以匹配到的端口谓词肯定是能封装成这个内容的规则，直接赋予其值或者直接push，然后再把这个bdd拆分成不同的原子，找到哪些原子可以组成这个bdd保存多个<ap,bdd>

如果不同的原子经过封装后的结果也是这个原子，那么就or一下，和原本记录里的bdd，最后封装后得到了一堆ap，bdd键值对


拆封装的时候：
还是使用了pop这个行为，不过要考虑中间的过滤行为

比如，1，2，3，4，5，经过encapip变成了7（dstip只有一个32位的，这个肯定是一个原子），这种情况下，比如说经过了层层转发，找到decapip的地方。

此时，根据history的历史去找encap的地方，然后根据现在到这里的原子（aps），寻找应该被怎么解封装。

- 如果是ip，封装后就一个原子，不会因为封装导致原子分散，而且是最后封装最先解封的，最快速，直接把转发前的拿出来似乎就可以？
- 如果是vni，封装后会出现多个原子，但是好处是只要你到了这里，就可以给你使用applyrewrite，因为把顶部拆了就可以，去掉一个域


# 跨vpn的话就会出现问题

leaf-0-0_vpn1_decapvni
core-0-0_vpn5_encapvni

[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, leaf-0-1, leaf-0-1_decapip, leaf-0-1_vc, leaf-0-1_vpn5_decapvni, leaf-0-1_vpn5, leaf-0-1_bd0]
leaf-0-2_vpn5->leaf-0-1_bd5
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, leaf-0-1, leaf-0-1_decapip, leaf-0-1_vc, leaf-0-1_vpn1_decapvni, leaf-0-1_vpn1, leaf-0-1_bd5]
leaf-0-2_vpn5->leaf-0-0_bd0
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, leaf-0-0, leaf-0-0_decapip, leaf-0-0_vc, leaf-0-0_vpn5_decapvni, leaf-0-0_vpn5, leaf-0-0_bd0]
leaf-0-2_vpn5->leaf-0-0_bd5
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, leaf-0-0, leaf-0-0_decapip, leaf-0-0_vc, leaf-0-0_vpn1_decapvni, leaf-0-0_vpn1, leaf-0-0_bd5]










core-0-0_decapip
leaf-0-5_vpn2_encapip
[leaf-0-5_vpn2, leaf-0-5_vpn2_encapvni, leaf-0-5_vpn2_encapip, leaf-0-5, spine-0-0, core-0-0]
855638017
{25654=25654, 29420=29420, 26686=26686}
[25856]
{25856=25856}


core-0-0_decapip
leaf-0-2_vpn4_encapip
[leaf-0-2_vpn4, leaf-0-2_vpn4_encapvni, leaf-0-2_vpn4_encapip, leaf-0-2, spine-0-1, core-0-0]
855638017
{44195=44195, 45188=45188, 45062=45062, 43574=43574}
[42464]
{42464=42464}

leaf-0-2_vpn5_encapip
[64500, 58948, 63946, 64730]
838860801
[19152, 64514, 45747, 64500, 55270, 39607, 31308]
838860803
[47650, 36035, 64772, 54352, 20310, 64730, 25018]
855638017
[27969, 58948, 22183, 63946, 51691, 31436, 21453, 42352, 42835, 58996, 55637, 63960, 39422, 38751]



leaf-0-2_vpn5_encapvni
[64514, 54352, 36035, 64730, 64772, 27969, 55637, 42352, 25018, 63946, 63960, 51691, 39422, 47650, 58948, 31308, 58996, 22183, 45747, 39607, 31436, 19152, 42835, 20310, 38751, 21453, 55270, 64500]
50005
[27969, 64514, 36035, 58948, 64772, 63946, 31308, 31436, 21453, 19152, 54352, 42835, 55637, 20310, 63960, 64730, 38751, 47650, 55270, 22183, 51691, 42352, 45747, 64500, 58996, 39607, 25018, 39422]




core-0-0_decapip
leaf-0-2_vpn5_encapip
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, core-0-0]
855638017
{58948=58948, 63946=63946}
[58676]
{58676=58676}

core-0-0_vpn5_decapvni
leaf-0-2_vpn5_encapvni
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, core-0-0, core-0-0_decapip, core-0-0_vc]
50005

{27969=27969, 58948=58948, 22183=22183, 63946=63946, 51691=51691, 31436=31436, 21453=21453, 42352=42352, 42835=42835, 58996=58996, 55637=55637, 63960=63960, 39422=39422, 38751=38751}

[27969, 64514, 36035, 64772, 58948, 63946, 31308, 
31436, 21453, 54352, 19152, 42835, 55637, 20310, 
63960, 64730, 38751, 47650, 55270, 22183, 51691, 
42352, 45747, 58996, 64500, 39607, 25018, 39422]

[58948, 63946]
{58948=58948, 63946=63946}


core-0-0_decapip
leaf-0-2_vpn5_encapip
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, core-0-0]
855638017
{58948=58948, 63946=63946}
[58676]
{58676=58676}

core-0-0_vpn5_decapvni
leaf-0-2_vpn5_encapvni
[leaf-0-2_vpn5, leaf-0-2_vpn5_encapvni, leaf-0-2_vpn5_encapip, leaf-0-2, spine-0-1, core-0-0, core-0-0_decapip, core-0-0_vc]
50005
{27969=27969, 64514=64514, 36035=36035, 64772=64772, 58948=58948, 63946=63946, 31308=31308, 
31436=31436, 21453=21453, 54352=54352, 19152=19152, 42835=42835, 55637=55637, 20310=20310,
63960=63960, 64730=64730, 38751=38751, 47650=47650, 55270=55270, 22183=22183, 51691=51691, 
42352=42352, 45747=45747, 58996=58996, 64500=64500, 39607=39607, 25018=25018, 39422=39422}

[58948, 63946]
{58948=58948, 63946=63946}

core-0-0_vpn5
[27969, 58948, 22183, 63946, 51691, 31436, 21453, 42352, 42835, 58996, 55637, 63960, 39422, 38751]
vxlan
[64514, 36035, 64772, 54218, 31308, 19152, 54352, 29778, 20310, 64730, 42651, 64609, 39777, 47650, 55270, 20017, 45747, 64500, 64565, 39607, 25018]
vpn1
[27969, 42835, 55637, 22183, 63960, 63946, 39422]
vbdif5
[42352, 58996, 58948, 51691, 31436, 21453, 38751]


vpn，encapvni，encapip（分裂，repair这个过程）
根据，aps，
apstack：true，vpn——vni，vni-ip
上一跳，找到上一条，ok，是natelement，根据ap搜索一边内容，看是否变小了，如果变小了，继续。下一个是转发，然后用现有的去寻找



在vpn5这里，原子被分为了两条路
第一条路是vbdif5
第二条路是vpn1
加入选了vpn1，变小，开始返回
到了decapvni，
# 增量运算

